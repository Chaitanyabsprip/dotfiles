#!/bin/sh

deansi() { sed 's/\x1B\[[0-9;]*[JKmsu]//g'; }

gitstatus() {
	pipe1="$(mktemp -u)"
	pipe2="$(mktemp -u)"
	mkfifo "$pipe1" "$pipe2"
	status="$(git -c color.status=always -c status.relativePaths=false status -sb)"

	{
		echo "$status" |
			deansi |
			sed 's/^ \([MTDARC]\)/_\1/' |
			tail -n +2 >"$pipe1"
	} &
	{
		git diff --color --stat HEAD 2>/dev/null |
			head -n -1 | sed 's/^ //' >"$pipe2"
	} &

	{
		echo "$status" | head -n1
		echo
		join -a1 -1 2 "$pipe1" "$pipe2" -o '1.1,1.2,2.2,2.3,2.4' | sed 's/^_/ /'
	} | gitcolor | align \| | align '+'
	rm "$pipe1" "$pipe2"
}

gitstatus
