#!/bin/sh

# setup environment
# first check dependencies
# install brew on mac
# install curl and git on *unix systems

depends curl && exit 1
depends git && exit 1

_bat() {
	have bat && return
	if [ "$(uname)" = 'Darwin' ]; then
		depends brew && return 1
		brew install bat
		return
	elif [ "$(uname)" = 'Linux' ]; then
		install-bat
	fi
}

_brew() {
	echo "TODO: install brew"
}

_curl() {
	echo "TODO: install curl"
}

_eza() {
	have eza && return
	if [ "$(uname)" = 'Darwin' ]; then
		depends brew && return 1
		brew install eza
		return
	elif [ "$(uname)" = 'Linux' ]; then
		install-eza
	fi
	ln -sf "$(which eza)" ~/.local/bin/exa
}

_fd() {
	have fd && return
	if [ "$(uname)" = 'Darwin' ]; then
		depends brew && return 1
		brew install fd
		return
	elif [ "$(uname)" = 'Linux' ]; then
		install-fd
	fi
}

_fzf() {
	have fzf && return
	spinner curl -LsS https://raw.githubusercontent.com/junegunn/fzf/master/install -o install
	spinner bash ./install --all
	rm ./install
	have fzf-tmux && return
	spinner curl -LsS https://raw.githubusercontent.com/junegunn/fzf/master/bin/fzf-tmux -o "$SCRIPTS"/fzf-tmux
	chmox "$SCRIPTS"/fzf-tmux
}

_git() {
	echo "TODO: install git"
}

_gitmux() {
	have gitmux && return
	install-gitmux
}

_gitui() {
	have gitui && return
	install-gitui
}

_go() {
	depends wget && return 1
	mkdir temp && { cd temp || :; }
	wget https://git.io/go-installer.sh
	chmox go-installer.sh
	bash go-installer.sh
	rm go*
	cd ..
}

_starship() {
	have starship && return
	if [ "$(uname)" = "Darwin" ] || [ "$(uname)" = "Linux" ]; then
		curl -sS https://starship.rs/install.sh -o starship.sh
		sh starship.sh -y 1>/dev/null 2>&1
		rm starship.sh
	else
		error "Couldn't install starship"
	fi
	success "starship successfully installed"
}

_tmux() {
	case "$DISTRO" in
	Debian | Ubuntu) sudo apt install tmux -y ;;
	Fedora | CentOS | RHEL) dnf install tmux -y ;;
	openSUSE | SUSE) zypper install tmux -y ;;
	Arch\ Linux) sudo pacman -S --nocomfirm tmux ;;
	*) return 1 ;;
	esac
	depends tmux && return 1
}

setup_tmux_complete() {
	_tmux
	_yq
	_gitmux
	_gitui
	_fd
	_fzf
}

_yq() {
	have yq && return
	install-yq
}

_zap_zsh() {
	have zap && return
	if [ "$(uname)" = "Darwin" ] || [ "$(uname)" = "Linux" ]; then
		curl -s https://raw.githubusercontent.com/zap-zsh/zap/master/install.zsh -o install.zsh
		zsh install.zsh --branch release-v1 --keep
		rm install.zsh
	else
		error "Couldn't install zap-zsh"
	fi
	success "zap-zsh successfully installed"
}

_zsh() {
	depends zsh && return 1
	case "$DISTRO" in
	Debian | Ubuntu) sudo apt install zsh -y ;;
	Fedora | CentOS | RHEL) dnf install zsh -y ;;
	openSUSE | SUSE) zypper install zsh -y ;;
	Arch\ Linux) sudo pacman -S --nocomfirm zsh ;;
	*) return 1 ;;
	esac
	echo export ZDOTDIR="$HOME"/.config/zsh >>"$HOME"/.profile
	success "Successfully installed zsh"
}

setup_zsh_complete() {
	_zsh
	_starship
	_zap_zsh
	_eza
	_bat
	success "base zsh shell setup complete"
}

setup_neovim() {
	install-neovim.sh
}

DISTRO=$(distro | cut -d ':' -f1)

# shellcheck disable=2016
setup_env() {
	echo 'export PATH=.:"$PATH"'
	echo 'export PATH="$PATH":~/.local/bin'
}

eval "$(setup_env)"

case "$1" in
zsh) _zsh ;;
tmux) _tmux ;;
nvim) setup_neovim ;;
env) setup_env ;;
fzf) _fzf ;;
bat) _bat ;;
go) _go ;;
all | '')
	setup_zsh_complete
	setup_tmux_complete
	setup_neovim
	;;
*) echo "specify a target" && exit 1 ;;
esac
